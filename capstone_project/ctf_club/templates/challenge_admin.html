{% extends 'layout.html' %}
{% block head %}
	<script type="application/javascript">
		document.addEventListener('DOMContentLoaded',function(){
			document.querySelectorAll('.make_challenge').forEach(el=>{
				{#console.log(el);#}
				el.addEventListener("click",event=>{
						modal_challenge(event,el.dataset.sn,el.dataset.edit);
				});
			});
			document.getElementById('submit_chal').addEventListener("click",event=>{
				event.preventDefault()
				submit_challenge()
			});

		});
		let CHALLENGES = {};
		{#let CHALLENGES2 = {};#}
		//I cache the challenges information to an object that's indexed based upon the challenge's sn or shortname.
		// | safe is there b/c otherwise django will escape all special chars to prevent XSS which I don't want as I made the text.
{#		{{  json | safe}}.forEach(chal=>{#}
{#			CHALLENGES[chal.sn] = chal;#}
{#		});#}

		{{ json | safe }}.forEach(chal=>{
			CHALLENGES[chal.sn] = chal;
		})

	  function modal_challenge(event,challenge_type,edit){
			event.preventDefault();
			let inner_content;
			switch(challenge_type){
				case "fizzbuzz":
					//Code like the one below makes me thing I should've done it in react's JSX.
					inner_content=`<div class="col-6">
						<div class="modal-input input-group mb-3">
							<div class="input-group-prepend">
								<label for="min" class="input-group-text">
								Min
								</label>
							</div>
							<input type="number" name="min" id="min" min="3" max="1200" class="input_items numbers"/>
						</div>
						<div class="modal-input input-group mb-3">
							<div class="input-group-prepend">
								<label for="max" class="input-group-text">
								Max
								</label>
							</div>
							<input type="number" name="max" id="max" min="1201" max="3000" class="input_items numbers"/>
						</div>
					</div>`;
					break;
				default:
					document.getElementById('submit_chal').disabled = true
					inner_content=`<div class="col-6 form-group">
						<textarea id='plain_text' name='plain_text' class="input_items form-text" rows="3" cols="40" onkeyup="check_len()"></textarea>
					</div>`;
					 if(challenge_type === 'hill' || challenge_type === 'affine'){
					 	inner_content += `<div class="col-6 form-group">
							<select id="variety"><option value="0">Easy</option>
					<option value="1">Hard</option></select>`;
					 }
					break;
			}


			let chal = CHALLENGES[challenge_type];
			const el = document.getElementById('input_description');
		 if (edit == 'true') {
			 el.innerHTML = `<p>For reference, the old challenge is below here.</p>`+chal.full_description+
				  `<pre>Flag: ${chal.flag}</pre>`;
		 }
		 else {
			 el.innerHTML = `<span>${chal.description}</span>`;
		 }
		 document.getElementById('challenge_modal_title').innerText = `${chal.name} -- Category:${chal.category}`;
			document.getElementById('input_row').innerHTML = inner_content;
			document.getElementById('sn').value = chal.sn;
			document.getElementById('editing').checked = (edit === 'true');
			$('#challenge_modal').modal('toggle');
		}

		function check_len(){
			const len = document.getElementById('plain_text').value.length;
			document.getElementById('submit_chal').disabled = (len == 0 )
		}

		function submit_challenge(){
			let content = {}
			const sn = document.getElementById('sn').value;
			content['sn'] = sn;
			content['name'] = CHALLENGES[sn].name;
			content['category'] = CHALLENGES[sn].category;
			if(sn in ['affine','hill']){
				content['variety'] = document.getElementById('variety').value;
			}
			else if(sn === 'fizzbuzz'){
				let min = parseInt(document.getElementById('min').value);
				let max = parseInt(document.getElementById('max').value);
				content['min'] = (min < 2 || min > 1200)?undefined:min
				content['max'] = (max < 1201 || max > 3000)?undefined:max
			}
			else{
				content['plaintext'] = document.getElementById('plain_text').value;
				if(content['plaintext'].length == 0 ){
					return;
				}
			}
			content['edit'] = document.getElementById('editing').checked;
			console.log(content)
			submit('/challenge_admin',content,response=>{
				console.log(response)
			})
		}
	</script>
{% endblock %}
{% block body %}
	<div class="container-lg container mt-3">
		<div class="row">
		{% for challenge in challenges %}
			<div class="col-md-4">
				<div class="card text-white bg-secondary mb-3">
					<div class="card-header">
						<span>{{ challenge.name }}</span>
					</div>
					<div class="card-title ml-2">
						{{ challenge.category }}
					</div>
					<div class="card-body">
						{{ challenge.description }}
					</div>
					<div class="card-footer">
						{% if challenge.edit == True %}
							<a href="#" class="btn btn-dark make_challenge" data-sn="{{ challenge.sn }}" data-edit="true">Edit Challenge</a>
						{% else %}
							<a href="#" class="btn btn-dark make_challenge" data-sn="{{ challenge.sn }}" data-edit="false">Create Challenge</a>
						{% endif %}
					</div>
				</div>
			</div>
		{% endfor %}
		</div>
	</div>

	<div class="modal fade" id="challenge_modal" tabindex="-1" role="dialog" aria-labelledby="modal_title" aria-hidden="true">
		<div class="modal-dialog modal-dialog-centered" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="challenge_modal_title"></h5>
			 	 <button type="button" class="close" data-dismiss="modal" aria-label="Close">
					 <span aria-hidden="true">&times;</span>
			 	 </button>
				</div>
				<div class="modal-body">
					<div class="row">
						<div class="col-11" id="input_description">
						</div>
					</div>
					<div class="row" id="input_row">

					</div>
					<input type="text" class="hidden" name="sn" id="sn" />
					<input type="checkbox" class="hidden" name="editing" id="editing" />
				</div>
				<div class="modal-footer">
					<button id="submit_chal" type="button" class="btn btn-secondary" data-dismiss="modal">Submit Challenge</button>
				</div>
			</div>
		</div>
	</div>
{% endblock %}